---
title: "Senior Data Analyst Assignment"
author: "Jacky Lam"
date: "6/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

1. <b> What are your main takeaways from the data? Briefly summarize and include trend analyses a few visualizations, including spatial ones if possible.</b>

Interactive Cluster map of CitiBike docks and the total count of Red lights from April 2019.

```{r, echo = FALSE}
library(leaflet)
library(fst)
setwd("~/Documents/R/citi_secret_no_git")
redlocagg = read.fst("redlocagg.fst")
leaflet() %>% 
  addTiles() %>%
  addLabelOnlyMarkers(data = redlocagg,
                      lng = ~lon, lat = ~lat,
                      label = ~as.character(paste(loc,n,sep = " - ")),
                      clusterOptions = markerClusterOptions(),
                      labelOptions = labelOptions(noHide = T,
                                                  direction = "auto")) %>%
  addProviderTiles(providers$CartoDB.Positron)

```

2. <b>Calculate overall mean trips between failure (MTBF), where MTBF = (total repairs)/(total trips). How does MTBF compare for repairs done in the bike shop and in the field?  </b>

* Total repairs/total trips = 0.01211929
  + In R: ```nrow(filter(repairs, step_type == "repair"))/sum(trips$trip_count)```
* MTBF in depot: 0.006012683
  + In R: ```nrow(filter(repairs, step_type == "repair" & location == "depot"))/sum(trips$trip_count)```
* MTBF in field: 0.006106606
  + In R: ```nrow(filter(repairs, step_type == "repair" & location == "field"))/sum(trips$trip_count)```
* MTBF in ```depot``` is lower than in the ```field```. This means that less repairs are being done in the depot and more repairs are done in the field.

<b>Bonus: How would you answer this question only using SQL (i.e what would your query look like using the provided tables)? (below query will work in RStudio!) </b>

```{r,echo=TRUE, warning=FALSE}
library(DBI)
library(RMySQL)
mydb = dbConnect(MySQL(), user='jacky',
             	password='Motivate2019',
                 host='citibike-data.cycyktz9ycag.us-east-2.rds.amazonaws.com', port = 3306,
             	dbname = 'citibike')

#(total repairs)/(total trips)
dbGetQuery(mydb,"
       	SELECT COUNT(step_type)
       	FROM repairs
       	WHERE step_type = 'repair'
       	;") / dbGetQuery(mydb,"
       	SELECT SUM(trip_count)
       	FROM trips
       	;")
#(total repairs)/(total trips) where location = “depot”
 dbGetQuery(mydb,"
           SELECT COUNT(step_type)
           FROM repairs
           WHERE step_type = 'repair' and
           location = 'depot';") / dbGetQuery(mydb,"
           SELECT SUM(trip_count)
           FROM trips
           ;")
#(total repairs)/(total trips) where location = “field”
dbGetQuery(mydb,"
           SELECT COUNT(step_type)
           FROM repairs
           WHERE step_type = 'repair' and
           location = 'field';") / dbGetQuery(mydb,"
           SELECT SUM(trip_count)
           FROM trips
           ;")
```
3. <b>How would you go about identifying trends in bicycle failures? Explain some approaches you would take to segment the data and suggest targeted approaches to reducing failure rates with supporting data analysis. </b>

* Location most bikes are being redlighted: there could be something on the route to this station that causes bikes to fail.
  + Left joined redlight dataset with public dataset by bike station id
  + Group by bike station id and count bike station id
```{r,echo=FALSE, warning=FALSE}
DT::datatable(redlocagg[,c(1,4)])
```
* Joining together the redlight dataset and the repairs dataset, I tracked the repair and redlight timeline of each bike.  If a bike was repaired and redlight more than once (I excluded one offs because we don’t know the last time it was repaired or the last time it red lighted), we can expect a bike to red light again in 6.45 days and for the repair to take 2.79 days.


4. <b>If you wanted to reduce overall customer red lights, what is some additional data you'd want to collect? Suggest potential approaches come to mind, and how would you measure their effectiveness? </b>
* Use breadcrumb data or route data to check what route most bikes take before they redlight. The route a bike took can cause excessive wear.
* Collect distance data, distance can be tracked and a logistic regression can be done to see how many miles a bike can go before it redlights
* Track the type of parts causing bike failure, a manufacturer could be providing bad parts, data column could be as simple as “part”: “gear”, ”handlebars”, ”crank_shaft”
* Track the model of bike that fails the most, a manufacturer could be providing a poor quality bike.
* Collect data on brake severity, hard braking is bad for a bike.

<br>

### <b>Follow up analysis:</b>


1. <b>Why or why not would MTBF be the standard metric for assessing the performance of a centralized bicycle shop? What other metrics would you propose and what data would you need to effectively track them? </b>
* MTBF should not be a standard metric for assessing the performance of a centralized bicycle shop. Although this metric tells you the proportion of repairs over trip volume, this metric doesn’t tell you the quality of the repair nor if the repair was completed, and it also doesn’t tell you the technican’s productivity.
* Metrics to collect: Days between redlight, time between service (how long was this bike out of service?), repair time, 

2. <b>If it was possible, how would you modify the organization of the data collected to better answer these questions? Would you collect additional information? Would you structure it differently?</b>

3. <b>How would you create a daily forecast of the number of bikes needing repair? Specify necessary data sources and any underlying assumptions.</b>

